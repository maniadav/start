(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[338],{6482:function(e,t,r){Promise.resolve().then(r.bind(r,4434))},4434:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return k}});var a=r(7437),n=r(2265),l=r(3949),o=r(9376),s=r(3991),i=r(2635),c=r(2762),d=r(2881),u=r(6849),m=r(1100),h=r(8755),f=e=>{let{showFilter:t,reAttemptUrl:r,taskID:n,attempt:l}=e;return(0,o.useRouter)(),console.log({showFilter:t}),(0,a.jsx)(m.p,{show:t,slideBottom:!0,children:(0,a.jsx)("div",{className:"fixed top-0 right-0 left-0 botom-0  w-full h-full flex items-center align-middle justify-center align-center overflow-y-auto bg-black",children:(0,a.jsx)("div",{className:"relative p-4 w-full max-w-xl max-h-full",children:(0,a.jsx)("div",{className:"relative bg-white rounded-lg shadow ",children:(0,a.jsx)("div",{className:"p-4 md:p-5 space-y-4",children:(0,a.jsx)(h.Z,{reAttemptUrl:r,showFilter:t,attempt:l,taskID:n})})})})})})},p=r(2464),g=r(3896),v=e=>{let{isSurvey:t=!1}=e,[r,l]=(0,n.useState)(!1),[m,h]=(0,n.useState)(!1),[v,x]=(0,n.useState)(null),[w,y]=(0,n.useState)({}),{windowSize:b,deviceType:j}=(0,c.Z)(),{state:k,dispatch:E}=(0,i.y)(),N=parseInt((0,o.useSearchParams)().get("attempt")||"0"),F=N<3?"".concat(g._,"/").concat(p.gq.surveyRoute,"?attempt=").concat(N+1):null,{startVidRecording:S,stopVidRecording:T,CameraPermissionPopupUI:P}=(0,u.Z)(),D=(0,n.useRef)(null),[_,C]=(0,n.useState)(3e4);(0,n.useEffect)(()=>{let e=D.current;return e&&(e.onloadedmetadata=()=>{C(1e3*e.duration)}),()=>{e&&(e.onloadedmetadata=null)}},[]),(0,n.useEffect)(()=>{t&&R()},[t]),(0,n.useEffect)(()=>{(null==v?void 0:v.isTimeOver)&&!m&&(O(v),h(!0))},[m,v]);let R=async()=>{await S(),L()},A=(0,n.useRef)(),L=()=>{let{endTimePromise:e,stopTimer:t}=(0,s.H)(_);return A.current=t,e.then(x),()=>{A.current&&A.current()}},U=(0,n.useCallback)(()=>{if(A.current)return A.current()},[]),O=(0,n.useCallback)(async function(e){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t&&(await T(),l(e=>!e),y(t=>{let a={...t,timrLimit:(null==e?void 0:e.timeLimit)||"",endTime:(null==e?void 0:e.endTime)||"",startTime:(null==e?void 0:e.startTime)||"",closedWithTimeout:(null==e?void 0:e.isTimeOver)||!1,screenHeight:b.height,screenWidth:b.width,closedMidWay:r,deviceType:j};return E({type:"UPDATE_SURVEY_DATA",attempt:N,task:p.gq.id,data:a}),a}))},[t,v,N,r]);return(0,a.jsxs)("div",{className:"relative w-screen h-screen overflow-hidden",children:[P,t&&(0,a.jsx)(d.Z,{handlePressAction:()=>{O(U(),!0)}}),(0,a.jsx)("div",{className:"w-screen h-screen relative bg-black",children:(0,a.jsx)("video",{ref:D,className:"absolute top-0 left-0 w-full h-full object-fit",autoPlay:!0,muted:!0,children:(0,a.jsx)("source",{src:"".concat(g._,"/video/start-plt.mp4"),type:"video/mp4"})})}),t&&(0,a.jsx)(f,{showFilter:r,onProcessComplete:l,reAttemptUrl:F,attempt:N,taskID:p.gq.id})]})},x=r(1522);let w=(0,n.createContext)(void 0),y=e=>{let{children:t}=e,[r,l]=(0,n.useState)([]);return(0,a.jsx)(w.Provider,{value:{gazeData:r,setGazeData:l},children:t})};var b=r(8422);let j=()=>{let[e,t]=(0,n.useState)(!1),r=()=>{t(!e)};return(0,a.jsx)(a.Fragment,{children:e?(0,a.jsx)(b.Z,{isFullScreen:e,children:(0,a.jsx)(v,{isSurvey:e})}):(0,a.jsxs)("div",{className:"w-full h-full overflow-hidden",children:[(0,a.jsx)(l.Z,{taskName:p.gq.title,taskMessage:p.gq.taskMessage,handleStartGame:()=>r()}),(0,a.jsx)(v,{})]})})};function k(){return(0,a.jsx)(x.Z,{children:(0,a.jsx)(y,{children:(0,a.jsx)(j,{})})})}},8755:function(e,t,r){"use strict";var a=r(7437),n=r(2265),l=r(3386),o=r(2807),s=r(6105),i=r(9376),c=r(1646),d=r(2635),u=r(6501),m=r(2894),h=r(3896),f=r(2464);t.Z=e=>{let{reAttemptUrl:t,showFilter:r,attempt:p,taskID:g,videoURL:v}=e,x=(0,n.useRef)(null),w=(0,n.useRef)(null),[y,b]=(0,n.useState)(0),[j,k]=(0,n.useState)([0]),[E,N]=(0,n.useState)([0]),[F]=(0,n.useState)(["initial"]),[S,T]=(0,n.useState)(!0),P=["social","nonsocial","social","nonsocial","nonsocial","social"],[D,_]=(0,n.useState)(""),{state:C,dispatch:R}=(0,d.y)(),A=(0,n.useRef)(null),L=(0,n.useRef)(null),U=(0,i.useRouter)(),O="".concat(h._,"/model/mediapipe/task-vision"),I="".concat(h._,"/model/mediapipe/face-landmark/face_landmarker.task");(0,n.useEffect)(()=>{r&&M().then(()=>{V()})},[r]);let M=async()=>{_("Loading MediaPipe model for gaze detection...");try{var e;let t=await l.n.forVisionTasks(O);try{A.current=await l.jr.createFromOptions(t,{baseOptions:{modelAssetPath:I,delegate:"GPU"},outputFaceBlendshapes:!0,runningMode:"VIDEO",numFaces:1})}catch(e){console.warn("GPU acceleration failed, falling back to CPU:",e),A.current=await l.jr.createFromOptions(t,{baseOptions:{modelAssetPath:I,delegate:"CPU"},outputFaceBlendshapes:!0,runningMode:"VIDEO",numFaces:1})}L.current=new l.ET(null===(e=w.current)||void 0===e?void 0:e.getContext("2d")),_("Model loaded successfully")}catch(t){let e=t instanceof Error?t.message:String(t);throw _("Error loading model: ".concat(e)),console.error("Detailed error:",t),Error("Unable to load face landmark model")}},V=async()=>{_("Fetching video data...");try{if(v){x.current&&(x.current.src=v,x.current.addEventListener("loadeddata",()=>{Z()}));return}let e=await (0,o.VS)(u.Y.temporaryDB,u.Y.tempVideo);if(e){let t=(0,s.o)(e,"video/webm"),r=URL.createObjectURL(t);x.current&&(x.current.src=r,x.current.addEventListener("loadeddata",()=>{Z()}))}else _("Unable to fetch video data. Please try again later."),T(!1)}catch(e){_("Error fetching video"),T(!1),console.error("Error fetching video:",e)}},Z=async()=>{if(_("processing video..."),!x.current||!w.current)return;let e=x.current,t=w.current,r=t.getContext("2d");e.width=720,e.height=400,t.width=720,t.height=400,e.playbackRate=1;try{await e.play()}catch(e){_("Error playing video"),console.error("Error playing video:",e);return}let a=0;e.pause();let n=async()=>{try{let o=e.currentTime;if(a++,r.clearRect(0,0,t.width,t.height),!A.current||"function"!=typeof A.current.detectForVideo)throw Error("faceLandmarkerRef.current model is unavailable");try{var n;let t=A.current.detectForVideo(e,performance.now());if((null==t?void 0:null===(n=t.faceLandmarks)||void 0===n?void 0:n[0])&&L.current){for(let e of t.faceLandmarks)L.current.drawConnectors(e,l.jr.FACE_LANDMARKS_TESSELATION,{color:"#C0C0C070",lineWidth:1});let e=t.faceLandmarks[0],r="";if(g==f.Ik.WheelTask.id)r=(0,c.z_)(e),_("Frame: ".concat(a,", Projected Distance: ").concat(r.toFixed(2)," cm at time ").concat(o.toFixed(3),"s"));else{r=(0,c.Kr)(e),_("Looking ".concat(r));let t=parseFloat(o.toFixed(3))||0;_("Frame: ".concat(a,", Direction: ").concat(r,", Time: ").concat(o.toFixed(3),"s"));let n=Math.floor(t/5);if(n<P.length){let e=P[n];"left"===r&&(e="social"===e?"nonsocial":"social"),F.push(e)}}E.push(o),j.push(r||"initial")}}catch(e){console.warn("Frame detection error:",e)}let s=o/e.duration*100;if(b(s),o>=e.duration){let t;(0,m.Sv)(j,"gaze-data"),t=g==f.Ik.WheelTask.id?{...C[g]["attempt".concat(p)],gazeDistance:j,gazeTiming:E,videoDuration:e.duration,totalFramesProcessed:a}:{...C[g]["attempt".concat(p)],gazeDirection:j,gazeTiming:E,gazeVidType:F,videoDuration:e.duration,totalFramesProcessed:a},R({type:"UPDATE_SURVEY_DATA",attempt:p,task:g,data:t}),_("Processing complete! Data saved."),T(!1);return}let i=Math.min(o+.03333333333333333,e.duration);e.currentTime=i}catch(e){console.error("Frame processing error:",e),_("Error processing frame ".concat(a,": ").concat(e))}},o=async()=>{await n()};return e.addEventListener("timeupdate",o),T(!0),e.currentTime=0,()=>{e.removeEventListener("timeupdate",o)}};return(0,a.jsx)("div",{className:"w-full h-full bg-gray-800 flex items-center justify-center align-middle",children:(0,a.jsxs)("div",{className:"w-full bg-white container max-w-3xl rounded-md",children:[(0,a.jsx)("div",{className:"w-full flex items-start justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600",children:(0,a.jsx)("h3",{className:"text-xl capitalize text-center font-semibold text-gray-900",children:S?"Wait while we process the video.":"Hurray, You have completed the survey!"})}),(0,a.jsxs)("div",{className:"p-4",children:[S&&(0,a.jsx)("p",{id:"eye-direction",className:"text-center text-gray-400 text-base",children:D}),(0,a.jsxs)("div",{className:"w-full h-[300px] max-w-2xl m-auto flex flex-col items-center relative",children:[(0,a.jsx)("video",{className:"absolute h-full w-full max-w-xl rounded-lg bg-gray-800",id:"webcam",ref:x,playsInline:!0,muted:!0,children:"Your browser does not support the video tag."}),(0,a.jsx)("canvas",{className:"absolute h-full w-full rounded-lg",id:"output_canvas",ref:w}),S&&(0,a.jsx)("p",{children:"We are processing the video, please wait..."})]}),S&&(0,a.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2.5 mt-4",children:(0,a.jsx)("div",{className:"bg-blue-600 h-2.5 rounded-full",style:{width:"".concat(y,"%")}})})]}),(0,a.jsxs)("div",{className:"w-full flex items-center justify-center p-4 border-t border-gray-200 rounded-b dark:border-gray-600",children:[(0,a.jsx)("button",{disabled:S,onClick:()=>U.push("/survey"),className:"".concat(S?"cursor-not-allowed opacity-50":"cursor-pointer"," capitalize text-white bg-red-800 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:hover:bg-red-700 dark:focus:ring-red-800"),children:"Go to Dashboard"}),t&&(0,a.jsx)("button",{disabled:S,onClick:()=>{!S&&window.location&&(window.location.href=t)},className:"".concat(S?"cursor-not-allowed opacity-50":"cursor-pointer"," ms-3 text-gray-200 bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:outline-none focus:ring-red-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5"),children:"Create New Attempt"})]})]})})}}},function(e){e.O(0,[699,972,145,845,386,75,923,971,522,744],function(){return e(e.s=6482)}),_N_E=e.O()}]);