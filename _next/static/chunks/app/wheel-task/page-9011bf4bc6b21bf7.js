(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[364],{1311:function(e,t,r){Promise.resolve().then(r.bind(r,9626))},9626:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return j}});var n=r(7437),o=r(2265),a=r(1789),i=r(6463),l=r(5345),s=r(2462),c=r(8002),u=r(1647),d=r(232),m=r(8398),f=r(1064),h=r(3972),p=r(636),v=r(7257),w=r(8437),y=r(1334),g=e=>{let{reAttemptUrl:t,showFilter:r,attempt:a,taskID:l,videoURL:c}=e,u=(0,o.useRef)(null),d=(0,o.useRef)(null),[g,b]=(0,o.useState)(0),[x,E]=(0,o.useState)([0]),[S,k]=(0,o.useState)([0]),[T,j]=(0,o.useState)(!0),[D,F]=(0,o.useState)(""),{state:R,dispatch:N}=(0,s.y)(),_=(0,o.useRef)(null),A=(0,o.useRef)(null),C=(0,i.useRouter)(),L="".concat(y._,"/model/mediapipe/task-vision"),P="".concat(y._,"/model/mediapipe/face-landmark/face_landmarker.task");(0,o.useEffect)(()=>{r&&O().then(()=>{U()})},[r]);let O=async()=>{F("Loading MediaPipe model for gaze detection...");try{var e;let t=await m.n.forVisionTasks(L);try{_.current=await m.jr.createFromOptions(t,{baseOptions:{modelAssetPath:P,delegate:"GPU"},outputFaceBlendshapes:!0,runningMode:"VIDEO",numFaces:1})}catch(e){console.warn("GPU acceleration failed, falling back to CPU:",e),_.current=await m.jr.createFromOptions(t,{baseOptions:{modelAssetPath:P,delegate:"CPU"},outputFaceBlendshapes:!0,runningMode:"VIDEO",numFaces:1})}A.current=new m.ET(null===(e=d.current)||void 0===e?void 0:e.getContext("2d")),F("Model loaded successfully")}catch(t){let e=t instanceof Error?t.message:String(t);throw F("Error loading model: ".concat(e)),console.error("Detailed error:",t),Error("Unable to load face landmark model")}},U=async()=>{F("Fetching video data...");try{if(c){u.current&&(u.current.src=c,u.current.addEventListener("loadeddata",()=>{V()}));return}let e=await (0,f.VS)(v.Y.temporaryDB,v.Y.tempVideo);if(e){let t=(0,h.o)(e,"video/webm"),r=URL.createObjectURL(t);u.current&&(u.current.src=r,u.current.addEventListener("loadeddata",()=>{V()}))}else F("Couldn't retrieve key ".concat(v.Y.tempVideo," from ").concat(v.Y.temporaryDB," database."))}catch(e){F("Error fetching video"),console.error("Error fetching video:",e)}},V=async()=>{if(F("processing video..."),!u.current||!d.current)return;let e=u.current,t=d.current,r=t.getContext("2d");e.width=720,e.height=400,t.width=720,t.height=400,e.playbackRate=1;try{await e.play()}catch(e){F("Error playing video"),console.error("Error playing video:",e);return}let n=0;e.pause();let o=async()=>{try{let i=e.currentTime;if(n++,r.clearRect(0,0,t.width,t.height),!_.current||"function"!=typeof _.current.detectForVideo)throw Error("faceLandmarkerRef.current model is unavailable");try{var o;let t=_.current.detectForVideo(e,performance.now());if((null==t?void 0:null===(o=t.faceLandmarks)||void 0===o?void 0:o[0])&&A.current){for(let e of t.faceLandmarks)A.current.drawConnectors(e,m.jr.FACE_LANDMARKS_TESSELATION,{color:"#C0C0C070",lineWidth:1});let e=t.faceLandmarks[0],r=(0,p.z_)(e);F("Frame ".concat(n,": Project Distance: ").concat(r.toFixed(2)," cm at time ").concat(i.toFixed(3),"s")),S.push(i),x.push(r)}}catch(e){console.warn("Frame detection error:",e)}let s=i/e.duration*100;if(b(s),i>=e.duration){(0,w.Sv)(x,"gaze-data");let t={...R[l]["attempt".concat(a)],gazeDistance:x,gazeTiming:S,videoDuration:e.duration,totalFramesProcessed:n};N({type:"UPDATE_SURVEY_DATA",attempt:a,task:l,data:t}),F("Processing complete! Data saved."),j(!1);return}let c=Math.min(i+.03333333333333333,e.duration);e.currentTime=c}catch(e){console.error("Frame processing error:",e),F("Error processing frame ".concat(n,": ").concat(e))}},i=async()=>{await o()};return e.addEventListener("timeupdate",i),j(!0),e.currentTime=0,()=>{e.removeEventListener("timeupdate",i)}};return(0,n.jsx)("div",{className:"w-full h-full bg-gray-800 flex items-center justify-center align-middle",children:(0,n.jsxs)("div",{className:"w-full bg-white container max-w-3xl rounded-md",children:[(0,n.jsx)("div",{className:"w-full flex items-start justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600",children:(0,n.jsx)("h3",{className:"text-xl capitalize text-center font-semibold text-gray-900",children:T?"Wait while we process the video.":"Hurray, You have completed the survey!"})}),(0,n.jsxs)("div",{className:"p-4",children:[T&&(0,n.jsx)("p",{id:"eye-direction",className:"text-center text-gray-400 text-base",children:D}),(0,n.jsxs)("div",{className:"w-full h-[300px] max-w-2xl m-auto flex flex-col items-center relative",children:[(0,n.jsx)("video",{className:"absolute h-full w-full max-w-xl rounded-lg bg-gray-800",id:"webcam",ref:u,playsInline:!0,muted:!0,children:"Your browser does not support the video tag."}),(0,n.jsx)("canvas",{className:"absolute h-full w-full rounded-lg",id:"output_canvas",ref:d}),T&&(0,n.jsx)("p",{children:"We are processing the video, please wait..."})]}),T&&(0,n.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2.5 mt-4",children:(0,n.jsx)("div",{className:"bg-blue-600 h-2.5 rounded-full",style:{width:"".concat(g,"%")}})})]}),(0,n.jsxs)("div",{className:"w-full flex items-center justify-center p-4 border-t border-gray-200 rounded-b dark:border-gray-600",children:[(0,n.jsx)("button",{disabled:T,onClick:()=>C.push("/survey"),className:"".concat(T?"cursor-not-allowed opacity-50":"cursor-pointer"," capitalize text-white bg-red-800 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:hover:bg-red-700 dark:focus:ring-red-800"),children:"Go to Dashboard"}),t&&(0,n.jsx)("button",{disabled:T,onClick:()=>{!T&&window.location&&(window.location.href=t)},className:"".concat(T?"cursor-not-allowed opacity-50":"cursor-pointer"," ms-3 text-gray-200 bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:outline-none focus:ring-red-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5"),children:"Create New Attempt"})]})]})})},b=r(8582),x=r(9891),E=e=>{let{isSurvey:t=!1}=e,[r,a]=(0,o.useState)(!1),[m,f]=(0,o.useState)(!1),[h,p]=(0,o.useState)(null),[v,w]=(0,o.useState)({}),{windowSize:E,deviceType:S}=(0,c.Z)(),{startVidRecording:k,stopVidRecording:T}=(0,u.Z)(),{state:j,dispatch:D}=(0,s.y)(),F=parseInt((0,i.useSearchParams)().get("attempt")||"0"),R=F<3?"/".concat(b.ho.surveyRoute,"?attempt=").concat(F+1):null;(0,o.useEffect)(()=>{t&&N()},[t]),(0,o.useEffect)(()=>{(null==h?void 0:h.isTimeOver)&&!m&&(L(h),f(!0))},[m,h]);let N=async()=>{await k(),A()},_=(0,o.useRef)(),A=()=>{let{endTimePromise:e,stopTimer:t}=(0,l.H)(3e4);return _.current=t,e.then(p),()=>{_.current&&_.current()}},C=(0,o.useCallback)(()=>{if(_.current)return _.current()},[]),L=(0,o.useCallback)(async function(e){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t&&(await T(),a(!0),w(t=>{let n={...t,timeLimit:(null==e?void 0:e.timeLimit)||"",timeTaken:(null==e?void 0:e.timeTaken)||"",endTime:(null==e?void 0:e.endTime)||"",startTime:(null==e?void 0:e.startTime)||"",closedWithTimeout:(null==e?void 0:e.isTimeOver)||!1,screenHeight:E.height,screenWidth:E.width,deviceType:S,closedMidWay:r};return D({type:"UPDATE_SURVEY_DATA",attempt:F,task:b.ho.id,data:n}),n}))},[t,h,F,E,S]);return(0,n.jsxs)("div",{className:"relative w-screen h-screen overflow-hidden",children:[t&&(0,n.jsx)(d.Z,{handlePressAction:()=>{L(C(),!0)}}),(0,n.jsx)("div",{className:"relative h-screen w-full",children:(0,n.jsx)("video",{src:"".concat(y._,"/video/wheel.mp4"),className:"absolute top-0 left-0 w-full h-full object-fit",autoPlay:!0,muted:!0,children:(0,n.jsx)("source",{src:"".concat(y._,"/gif/plt.gif"),type:"video/mp4"})})}),(0,n.jsx)("div",{className:"absolute bottom-5 left-5",children:(0,n.jsx)("button",{className:"border border-black shadow-lg rounded-full bg-primary w-16 h-16 px-2 py-1 animate-recPulse ",onClick:()=>{t?L(C()):alert("you may start the game!")}})}),t&&(0,n.jsx)(x.p,{show:r,children:(0,n.jsx)(g,{showFilter:r,reAttemptUrl:R,attempt:F,taskID:b.ho.id})})]})},S=r(8214),k=r(872);let T=()=>{let[e,t]=(0,o.useState)(!1),r=()=>{t(!e)};return(0,n.jsx)(n.Fragment,{children:e?(0,n.jsx)(k.Z,{isFullScreen:e,children:(0,n.jsx)(E,{isSurvey:e})}):(0,n.jsxs)("div",{className:"w-full h-full overflow-hidden",children:[(0,n.jsx)(a.Z,{taskName:b.ho.title,taskMessage:b.ho.taskMessage,handleStartGame:()=>r()}),(0,n.jsx)(E,{})]})})};function j(){return(0,n.jsx)(S.Z,{children:(0,n.jsx)(T,{})})}},232:function(e,t,r){"use strict";var n=r(7437),o=r(2265);t.Z=e=>{let{handlePressAction:t}=e,[r,a]=(0,o.useState)(null),i=e=>{r&&r!==e?(console.log("close action will handle"),t(),a(null)):(a(e),setTimeout(()=>{a(null)},5e3))};return(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"z-50 fixed right-0 top-0 p-3 cursor-pointer w-16 h-16 ",onClick:()=>i("top")}),(0,n.jsx)("div",{className:"z-50 fixed right-0 bottom-0 p-3 cursor-pointer w-16 h-16",onClick:()=>i("bottom")})]})}},872:function(e,t,r){"use strict";var n=r(7437),o=r(2265);t.Z=e=>{let{isFullScreen:t,children:r}=e,a=(0,o.useRef)(null);(0,o.useEffect)(()=>{t?i():l()},[t]);let i=async()=>{try{if(a.current){let e=a.current;e.requestFullscreen?await e.requestFullscreen():e.mozRequestFullScreen?await e.mozRequestFullScreen():e.webkitRequestFullscreen?await e.webkitRequestFullscreen():e.msRequestFullscreen&&await e.msRequestFullscreen()}}catch(e){console.error("Error trying to enter fullscreen mode:",e)}},l=async()=>{try{document.fullscreenElement&&(document.exitFullscreen?await document.exitFullscreen():document.mozCancelFullScreen?await document.mozCancelFullScreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.msExitFullscreen&&await document.msExitFullscreen())}catch(e){console.error("Error trying to exit fullscreen mode:",e)}};return(0,n.jsx)("div",{ref:a,style:{height:"100vh",width:"100vw",backgroundColor:"#f0f0f0"},children:r})}},1334:function(e,t,r){"use strict";r.d(t,{_:function(){return n}});let n="/start"},7257:function(e,t,r){"use strict";r.d(t,{Y:function(){return o},g:function(){return n}});let n={LOGGED_IN_USER:"start_user",MFA_ACCESS_TOKEN:"x-secure-token",MFA_REFRESH_TOKEN:"x-refresh-token",SELECTED_COUNTRY:"psychSelectedCountry",SELECTED_COUNTRY_NAME:"psychSelectedCountryName",SELECTED_VENDORCODE:"psychSelectedVendorCode",SELECTED_LANGUAGE:"psychSelectedLanguageFilter",BASE_URL:"https://x3qrf2-3000.csb.app/api/v1",SURVEY_DATA:"surveyData"},o={surveyDB:"survey",surveyData:"surveyData",useData:"user",tempVideo:"tempVideo",temporaryDB:"temporary"}},3972:function(e,t,r){"use strict";r.d(t,{l:function(){return n},o:function(){return o}});let n=e=>new Promise((t,r)=>{let n=new FileReader;n.onloadend=()=>{n.result?t(n.result.split(",")[1]):r("Failed to convert file to base64")},n.onerror=()=>{r("File reading error")},n.readAsDataURL(e)});function o(e,t,r){let n=atob(e.split(",")[1]||e),o=n.length,a=new Uint8Array(o);for(let e=0;e<o;e++)a[e]=n.charCodeAt(e);let i=new Blob([a],{type:t});if(!r){let e=t.split("/")[1]||"file";r="file.".concat(e)}return new File([i],r,{type:t})}},8437:function(e,t,r){"use strict";r.d(t,{Sv:function(){return n}});let n=(e,t)=>{let r=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=window.URL.createObjectURL(r),o=document.createElement("a");o.setAttribute("href",n),o.setAttribute("download",t),o.click(),window.URL.revokeObjectURL(n)}},1647:function(e,t,r){"use strict";var n=r(7257),o=r(3972),a=r(1064),i=r(2265);t.Z=()=>{let e=(0,i.useRef)(null),t=(0,i.useRef)([]),[r,l]=(0,i.useState)(!1),[s,c]=(0,i.useState)(null);return{isRecording:r,startVidRecording:async()=>{try{let r=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});c(r),e.current=new MediaRecorder(r,{mimeType:"video/webm"}),e.current.ondataavailable=e=>{e.data.size>0&&t.current.push(e.data)},e.current.start(),l(!0)}catch(e){console.error("Error accessing media devices.",e),alert("Camera access is required for this task"),window.location.reload()}},stopVidRecording:()=>new Promise(r=>{e.current?(e.current.stop(),e.current.onstop=async()=>{let e=new Blob(t.current,{type:"video/webm"});try{let i=new File([e],"video.webm",{type:"video/webm"}),u=await (0,o.l)(i);await (0,a.TP)(n.Y.temporaryDB,n.Y.tempVideo,u),t.current=[],l(!1),s&&(s.getTracks().forEach(e=>e.stop()),c(null)),r(u)}catch(e){console.error("Error converting video to base64:",e),r(null)}}):r(null)})}}},8002:function(e,t,r){"use strict";r.d(t,{Z:function(){return o}});var n=r(2265);function o(){let[e,t]=(0,n.useState)({width:void 0,height:void 0}),[r,o]=(0,n.useState)(void 0);(0,n.useEffect)(()=>{let e=()=>{t({width:window.innerWidth,height:window.innerHeight})};return"undefined"!=typeof navigator&&o(navigator.userAgent),window.addEventListener("resize",e),e(),()=>window.removeEventListener("resize",e)},[]);let a="number"==typeof(null==e?void 0:e.width)&&(null==e?void 0:e.width)<768,i="number"==typeof(null==e?void 0:e.width)&&(null==e?void 0:e.width)>=768;return{windowSize:e,isMobile:a,isDesktop:i,deviceType:r}}},2462:function(e,t,r){"use strict";r.d(t,{SurveyProvider:function(){return h},y:function(){return p}});var n=r(7437),o=r(7257);let{childID:a,childDOB:i,childGender:l}=(0,r(7413).jy)(o.g.LOGGED_IN_USER,!0)||{},s=e=>({assestment_id:e,noOfAttempt:0,attempt1:{},attempt2:{},attempt3:{},userID:""});s("BubblePoppingTask"),s("MotorFollowingTask"),s("ButtonTask");let c=["BubblePoppingTask","DelayedGratificationTask","MotorFollowingTask","ButtonTask","SynchronyTask","LanguageSamplingTask","WheelTask","PreferentialLookingTask"].reduce((e,t)=>(e[t]={...s(t),userID:a,userDOB:i,userGender:l},e),{});var u=r(1064),d=r(2265);let m=(0,d.createContext)(void 0),f=(e,t)=>{switch(t.type){case"SET_SURVEY_DATA":return{...e,...t.payload};case"UPDATE_SURVEY_DATA":var r;return{...e,[t.task]:{...e[t.task],noOfAttempt:t.attempt,["attempt".concat(t.attempt)]:{...null===(r=e[t.task])||void 0===r?void 0:r["attempt".concat(null==t?void 0:t.attempt)],...t.data}}};default:return{...e}}},h=e=>{let{children:t}=e,[r,a]=(0,d.useReducer)(f,c),[i,l]=(0,d.useState)(!1);return(0,d.useEffect)(()=>{(async()=>{try{let e=await (0,u.VS)(o.Y.surveyDB,o.Y.surveyData);e&&!i&&a({type:"SET_SURVEY_DATA",payload:e})}catch(e){console.error("Failed to load persisted survey state:",e)}finally{l(!0)}})()},[i]),(0,d.useEffect)(()=>{i&&(async()=>{try{await (0,u.TP)(o.Y.surveyDB,o.Y.surveyData,r)}catch(e){console.error("Failed to save survey state:",e)}})()},[r,i]),(0,n.jsx)(m.Provider,{value:{state:r,dispatch:a},children:t})},p=()=>{let e=(0,d.useContext)(m);if(!e)throw Error("useSurveyContext must be used within a SurveyProvider");return e}},1064:function(e,t,r){"use strict";function n(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return new Promise((r,n)=>{let o=indexedDB.open(e,t);o.onsuccess=()=>r(o.result),o.onerror=()=>n("Failed to open database: ".concat(e)),o.onupgradeneeded=()=>{let e=o.result;e.objectStoreNames.contains("data")||e.createObjectStore("data")}})}async function o(e,t,r){try{let o=await n(e),a=o.transaction("data","readwrite");a.objectStore("data").put(r,t),a.oncomplete=()=>{o.close()},a.onerror=t=>{console.error("Transaction error in ".concat(e,":"),t)}}catch(t){console.error("Error setting value in ".concat(e,":"),t)}}async function a(e,t){try{let r=await n(e);return new Promise((n,o)=>{let a=r.transaction("data","readonly").objectStore("data").get(t);a.onsuccess=()=>{let e=a.result;n(e),r.close()},a.onerror=()=>{o("Failed to retrieve data from ".concat(e)),r.close()}})}catch(t){return console.error("Error getting value from ".concat(e,":"),t),null}}async function i(e,t){try{let r=await n(e),o=r.transaction("data","readwrite");o.objectStore("data").delete(t),o.oncomplete=()=>r.close()}catch(t){console.error("Error removing value from ".concat(e,":"),t)}}r.d(t,{TP:function(){return o},VS:function(){return a},pV:function(){return i}}),r(7257)},7413:function(e,t,r){"use strict";function n(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("localStorage"in window)try{let r=window.localStorage.getItem(e);if(!r)return null;if(!t)return r;if(r)return JSON.parse(r)}catch(e){}return null}function o(e,t,r){if("localStorage"in window)try{r?window.localStorage.setItem(e,JSON.stringify(t)):"string"==typeof t&&window.localStorage.setItem(e,t)}catch(e){console.log(e)}return null}function a(){"localStorage"in window&&window.localStorage.clear()}r.d(t,{jy:function(){return n},pO:function(){return a},uN:function(){return o}})},636:function(e,t,r){"use strict";function n(e){if(!(null==e?void 0:e[468])||!(null==e?void 0:e[473])||!(null==e?void 0:e[33])||!(null==e?void 0:e[263]))return"Invalid landmarks";let t=e[468],r=e[473],n=e[33],o=e[263];function a(e,t){let r=e.x-t.x,n=e.y-t.y;return Math.sqrt(r*r+n*n)}let i=a(t,n),l=a(r,o);return i>l?"left":l>i?"right":"center"}r.d(t,{Kr:function(){return n},z_:function(){return o}});let o=e=>{if(!(null==e?void 0:e[33])||!(null==e?void 0:e[263]))return 0;let t=null==e?void 0:e[33],r=null==e?void 0:e[263];return Math.sqrt(Math.pow(t.x-r.x,2)+Math.pow(t.y-r.y,2))}},5345:function(e,t,r){"use strict";r.d(t,{H:function(){return o}});let n=e=>new Date(new Date(e).getTime()).toLocaleString("en-IN",{timeZone:"Asia/Kolkata",hour12:!0}),o=e=>{let t;let r=Date.now(),o=n(r);return{endTimePromise:new Promise(r=>{t=setTimeout(()=>{r(Date.now())},e)}).then(t=>{let a=t-r;return{startTime:o,endTime:n(t),timeLimit:e,isTimeOver:a>=e,timeTaken:a}}),stopTimer:()=>{clearTimeout(t);let a=Date.now(),i=a-r;return{startTime:o,endTime:n(a),timeLimit:e,isTimeOver:i>=e,timeTaken:i}}}}}},function(e){e.O(0,[231,812,398,642,971,275,744],function(){return e(e.s=1311)}),_N_E=e.O()}]);