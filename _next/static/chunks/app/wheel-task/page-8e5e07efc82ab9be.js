(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[364],{1311:function(e,t,r){Promise.resolve().then(r.bind(r,3186))},3186:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return S}});var a=r(7437),n=r(2265),o=r(3949),s=r(9376),l=r(3991),c=r(2635),i=r(2762),d=r(6849),u=r(2881),m=r(3386),h=r(2807),f=r(6105),p=r(1646),g=r(6501),v=r(2894),x=r(3896),w=e=>{let{reAttemptUrl:t,showFilter:r,attempt:o,taskID:l,videoURL:i}=e,d=(0,n.useRef)(null),u=(0,n.useRef)(null),[w,y]=(0,n.useState)(0),[b,j]=(0,n.useState)([0]),[k,E]=(0,n.useState)([0]),[N,S]=(0,n.useState)(!0),[T,_]=(0,n.useState)(""),{state:F,dispatch:C}=(0,c.y)(),P=(0,n.useRef)(null),A=(0,n.useRef)(null),D=(0,s.useRouter)(),L="".concat(x._,"/model/mediapipe/task-vision"),R="".concat(x._,"/model/mediapipe/face-landmark/face_landmarker.task");(0,n.useEffect)(()=>{r&&O().then(()=>{U()})},[r]);let O=async()=>{_("Loading MediaPipe model for gaze detection...");try{var e;let t=await m.n.forVisionTasks(L);try{P.current=await m.jr.createFromOptions(t,{baseOptions:{modelAssetPath:R,delegate:"GPU"},outputFaceBlendshapes:!0,runningMode:"VIDEO",numFaces:1})}catch(e){console.warn("GPU acceleration failed, falling back to CPU:",e),P.current=await m.jr.createFromOptions(t,{baseOptions:{modelAssetPath:R,delegate:"CPU"},outputFaceBlendshapes:!0,runningMode:"VIDEO",numFaces:1})}A.current=new m.ET(null===(e=u.current)||void 0===e?void 0:e.getContext("2d")),_("Model loaded successfully")}catch(t){let e=t instanceof Error?t.message:String(t);throw _("Error loading model: ".concat(e)),console.error("Detailed error:",t),Error("Unable to load face landmark model")}},U=async()=>{_("Fetching video data...");try{if(i){d.current&&(d.current.src=i,d.current.addEventListener("loadeddata",()=>{V()}));return}let e=await (0,h.VS)(g.Y.temporaryDB,g.Y.tempVideo);if(e){let t=(0,f.o)(e,"video/webm"),r=URL.createObjectURL(t);d.current&&(d.current.src=r,d.current.addEventListener("loadeddata",()=>{V()}))}else _("Couldn't retrieve key ".concat(g.Y.tempVideo," from ").concat(g.Y.temporaryDB," database."))}catch(e){_("Error fetching video"),console.error("Error fetching video:",e)}},V=async()=>{if(_("processing video..."),!d.current||!u.current)return;let e=d.current,t=u.current,r=t.getContext("2d");e.width=720,e.height=400,t.width=720,t.height=400,e.playbackRate=1;try{await e.play()}catch(e){_("Error playing video"),console.error("Error playing video:",e);return}let a=0;e.pause();let n=async()=>{try{let s=e.currentTime;if(a++,r.clearRect(0,0,t.width,t.height),!P.current||"function"!=typeof P.current.detectForVideo)throw Error("faceLandmarkerRef.current model is unavailable");try{var n;let t=P.current.detectForVideo(e,performance.now());if((null==t?void 0:null===(n=t.faceLandmarks)||void 0===n?void 0:n[0])&&A.current){for(let e of t.faceLandmarks)A.current.drawConnectors(e,m.jr.FACE_LANDMARKS_TESSELATION,{color:"#C0C0C070",lineWidth:1});let e=t.faceLandmarks[0],r=(0,p.z_)(e);_("Frame ".concat(a,": Project Distance: ").concat(r.toFixed(2)," cm at time ").concat(s.toFixed(3),"s")),k.push(s),b.push(r)}}catch(e){console.warn("Frame detection error:",e)}let c=s/e.duration*100;if(y(c),s>=e.duration){(0,v.Sv)(b,"gaze-data");let t={...F[l]["attempt".concat(o)],gazeDistance:b,gazeTiming:k,videoDuration:e.duration,totalFramesProcessed:a};C({type:"UPDATE_SURVEY_DATA",attempt:o,task:l,data:t}),_("Processing complete! Data saved."),S(!1);return}let i=Math.min(s+.03333333333333333,e.duration);e.currentTime=i}catch(e){console.error("Frame processing error:",e),_("Error processing frame ".concat(a,": ").concat(e))}},s=async()=>{await n()};return e.addEventListener("timeupdate",s),S(!0),e.currentTime=0,()=>{e.removeEventListener("timeupdate",s)}};return(0,a.jsx)("div",{className:"w-full h-full bg-gray-800 flex items-center justify-center align-middle",children:(0,a.jsxs)("div",{className:"w-full bg-white container max-w-3xl rounded-md",children:[(0,a.jsx)("div",{className:"w-full flex items-start justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600",children:(0,a.jsx)("h3",{className:"text-xl capitalize text-center font-semibold text-gray-900",children:N?"Wait while we process the video.":"Hurray, You have completed the survey!"})}),(0,a.jsxs)("div",{className:"p-4",children:[N&&(0,a.jsx)("p",{id:"eye-direction",className:"text-center text-gray-400 text-base",children:T}),(0,a.jsxs)("div",{className:"w-full h-[300px] max-w-2xl m-auto flex flex-col items-center relative",children:[(0,a.jsx)("video",{className:"absolute h-full w-full max-w-xl rounded-lg bg-gray-800",id:"webcam",ref:d,playsInline:!0,muted:!0,children:"Your browser does not support the video tag."}),(0,a.jsx)("canvas",{className:"absolute h-full w-full rounded-lg",id:"output_canvas",ref:u}),N&&(0,a.jsx)("p",{children:"We are processing the video, please wait..."})]}),N&&(0,a.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2.5 mt-4",children:(0,a.jsx)("div",{className:"bg-blue-600 h-2.5 rounded-full",style:{width:"".concat(w,"%")}})})]}),(0,a.jsxs)("div",{className:"w-full flex items-center justify-center p-4 border-t border-gray-200 rounded-b dark:border-gray-600",children:[(0,a.jsx)("button",{disabled:N,onClick:()=>D.push("/survey"),className:"".concat(N?"cursor-not-allowed opacity-50":"cursor-pointer"," capitalize text-white bg-red-800 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:hover:bg-red-700 dark:focus:ring-red-800"),children:"Go to Dashboard"}),t&&(0,a.jsx)("button",{disabled:N,onClick:()=>{!N&&window.location&&(window.location.href=t)},className:"".concat(N?"cursor-not-allowed opacity-50":"cursor-pointer"," ms-3 text-gray-200 bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:outline-none focus:ring-red-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5"),children:"Create New Attempt"})]})]})})},y=r(2464),b=r(1100),j=e=>{let{isSurvey:t=!1}=e,[r,o]=(0,n.useState)(!1),[m,h]=(0,n.useState)(!1),[f,p]=(0,n.useState)(null),[g,v]=(0,n.useState)({}),{windowSize:j,deviceType:k}=(0,i.Z)(),{startVidRecording:E,stopVidRecording:N,CameraPermissionPopupUI:S}=(0,d.Z)(),{state:T,dispatch:_}=(0,c.y)(),F=parseInt((0,s.useSearchParams)().get("attempt")||"0"),C=F<3?"".concat(x._,"/").concat(y.ho.surveyRoute,"?attempt=").concat(F+1):null;(0,n.useEffect)(()=>{t&&P()},[t]),(0,n.useEffect)(()=>{(null==f?void 0:f.isTimeOver)&&!m&&(R(f),h(!0))},[m,f]);let P=async()=>{await E(),D()},A=(0,n.useRef)(),D=()=>{let{endTimePromise:e,stopTimer:t}=(0,l.H)(3e4);return A.current=t,e.then(p),()=>{A.current&&A.current()}},L=(0,n.useCallback)(()=>{if(A.current)return A.current()},[]),R=(0,n.useCallback)(async function(e){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t&&(await N(),o(!0),v(t=>{let a={...t,timeLimit:(null==e?void 0:e.timeLimit)||"",timeTaken:(null==e?void 0:e.timeTaken)||"",endTime:(null==e?void 0:e.endTime)||"",startTime:(null==e?void 0:e.startTime)||"",closedWithTimeout:(null==e?void 0:e.isTimeOver)||!1,screenHeight:j.height,screenWidth:j.width,deviceType:k,closedMidWay:r};return _({type:"UPDATE_SURVEY_DATA",attempt:F,task:y.ho.id,data:a}),a}))},[t,f,F,j,k]);return(0,a.jsxs)("div",{className:"relative w-screen h-screen overflow-hidden",children:[S,t&&(0,a.jsx)(u.Z,{handlePressAction:()=>{R(L(),!0)}}),(0,a.jsx)("div",{className:"relative h-screen w-full",children:(0,a.jsx)("video",{src:"".concat(x._,"/video/wheel.mp4"),className:"absolute top-0 left-0 w-full h-full object-fit",autoPlay:!0,muted:!0,children:(0,a.jsx)("source",{src:"".concat(x._,"/gif/plt.gif"),type:"video/mp4"})})}),(0,a.jsx)("div",{className:"absolute bottom-5 left-5",children:(0,a.jsx)("button",{className:"border border-black shadow-lg rounded-full bg-primary w-16 h-16 px-2 py-1 animate-recPulse ",onClick:()=>{t?R(L()):alert("you may start the game!")}})}),t&&(0,a.jsx)(b.p,{show:r,children:(0,a.jsx)(w,{showFilter:r,reAttemptUrl:C,attempt:F,taskID:y.ho.id})})]})},k=r(1522),E=r(8422);let N=()=>{let[e,t]=(0,n.useState)(!1),r=()=>{t(!e)};return(0,a.jsx)(a.Fragment,{children:e?(0,a.jsx)(E.Z,{isFullScreen:e,children:(0,a.jsx)(j,{isSurvey:e})}):(0,a.jsxs)("div",{className:"w-full h-full overflow-hidden",children:[(0,a.jsx)(o.Z,{taskName:y.ho.title,taskMessage:y.ho.taskMessage,handleStartGame:()=>r()}),(0,a.jsx)(j,{})]})})};function S(){return(0,a.jsx)(k.Z,{children:(0,a.jsx)(N,{})})}}},function(e){e.O(0,[699,972,145,845,386,75,923,971,522,744],function(){return e(e.s=1311)}),_N_E=e.O()}]);