"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[583],{3583:function(e,t,r){r.d(t,{Z:function(){return y}});var a=r(7437),n=r(2265),o=r(3386),c=r(2807),l=r(6105),i=r(9376);let s=e=>{if(!(null==e?void 0:e[33])||!(null==e?void 0:e[263]))return 0;let t=null==e?void 0:e[33],r=null==e?void 0:e[263];return Math.sqrt(Math.pow(t.x-r.x,2)+Math.pow(t.y-r.y,2))};var d=r(2635),u=r(6501);let f=(e,t)=>{let r=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=window.URL.createObjectURL(r),n=document.createElement("a");n.setAttribute("href",a),n.setAttribute("download",t),n.click(),window.URL.revokeObjectURL(a)};var m=r(3896),p=r(2464),y=e=>{let{reAttemptUrl:t,showFilter:r,attempt:y,taskID:h,videoURL:g}=e,v=(0,n.useRef)(null),w=(0,n.useRef)(null),[E,b]=(0,n.useState)(0),[x,S]=(0,n.useState)([0]),[k,D]=(0,n.useState)([0]),[T]=(0,n.useState)(["initial"]),[_,F]=(0,n.useState)(!0),A=["social","nonsocial","social","nonsocial","nonsocial","social"],[N,j]=(0,n.useState)(""),{state:R,dispatch:C}=(0,d.y)(),L=(0,n.useRef)(null),U=(0,n.useRef)(null),O=(0,i.useRouter)(),P="".concat(m._,"/model/mediapipe/task-vision"),V="".concat(m._,"/model/mediapipe/face-landmark/face_landmarker.task");(0,n.useEffect)(()=>{r&&Y().then(()=>{M()})},[r]);let Y=async()=>{j("Loading MediaPipe model for gaze detection...");try{var e;let t=await o.n.forVisionTasks(P);try{L.current=await o.jr.createFromOptions(t,{baseOptions:{modelAssetPath:V,delegate:"GPU"},outputFaceBlendshapes:!0,runningMode:"VIDEO",numFaces:1})}catch(e){console.warn("GPU acceleration failed, falling back to CPU:",e),L.current=await o.jr.createFromOptions(t,{baseOptions:{modelAssetPath:V,delegate:"CPU"},outputFaceBlendshapes:!0,runningMode:"VIDEO",numFaces:1})}U.current=new o.ET(null===(e=w.current)||void 0===e?void 0:e.getContext("2d")),j("Model loaded successfully")}catch(t){let e=t instanceof Error?t.message:String(t);throw j("Error loading model: ".concat(e)),console.error("Detailed error:",t),Error("Unable to load face landmark model")}},M=async()=>{j("Fetching video data...");try{if(g){v.current&&(v.current.src=g,v.current.addEventListener("loadeddata",()=>{B()}));return}let e=await (0,c.VS)(u.Y.temporaryDB,u.Y.tempVideo);if(e){let t=(0,l.o)(e,"video/webm"),r=URL.createObjectURL(t);v.current&&(v.current.src=r,v.current.addEventListener("loadeddata",()=>{B()}))}else j("Unable to fetch video data. Please try again later."),F(!1)}catch(e){j("Error fetching video"),F(!1),console.error("Error fetching video:",e)}},B=async()=>{if(j("processing video..."),!v.current||!w.current)return;let e=v.current,t=w.current,r=t.getContext("2d");e.width=720,e.height=400,t.width=720,t.height=400,e.playbackRate=1;try{await e.play()}catch(e){j("Error playing video"),console.error("Error playing video:",e);return}let a=0;e.pause();let n=async()=>{try{let c;let l=e.currentTime;if(r.clearRect(0,0,t.width,t.height),!L.current||"function"!=typeof L.current.detectForVideo)throw Error("faceLandmarkerRef.current model is unavailable");let i="no-eye-detected";try{var n;let t=L.current.detectForVideo(e,performance.now());if((null==t?void 0:null===(n=t.faceLandmarks)||void 0===n?void 0:n[0])&&U.current){for(let e of t.faceLandmarks)U.current.drawConnectors(e,o.jr.FACE_LANDMARKS_TESSELATION,{color:"#C0C0C070",lineWidth:1});let e=t.faceLandmarks[0];if(h==p.Ik.WheelTask.id)i=s(e),j("Frame: ".concat(a,", Projected Distance: ").concat(i.toFixed(2),", Time: ").concat(l.toFixed(3),"s"));else{i=function(e){if(!(null==e?void 0:e[468])||!(null==e?void 0:e[473])||!(null==e?void 0:e[33])||!(null==e?void 0:e[263]))return"Invalid landmarks";let t=e[468],r=e[473],a=e[33],n=e[263];function o(e,t){let r=e.x-t.x,a=e.y-t.y;return Math.sqrt(r*r+a*a)}let c=o(t,a),l=o(r,n);return c>l?"left":l>c?"right":"center"}(e),j("Looking ".concat(i));let t=parseFloat(l.toFixed(3))||0;j("Frame: ".concat(a,", Direction: ").concat(i,", Time: ").concat(l.toFixed(3),"s"));let r=Math.floor(t/5);r<A.length&&(c=A[r],"left"===i&&(c="social"===c?"nonsocial":"social"))}}else j("Frame: ".concat(a,", No eye detected, Time: ").concat(l.toFixed(3),"s"))}catch(e){console.warn("Frame detection error:",e)}T.push(c||"no-eye-detected"),k.push(l),x.push(i||"no-eye-detected");let d=l/e.duration*100;if(b(d),l>=e.duration){let t;f(x,"gaze-data"),t=h==p.Ik.WheelTask.id?{...R[h]["attempt".concat(y)],gazeDistance:x,gazeTiming:k,videoDuration:e.duration,totalFramesProcessed:a}:{...R[h]["attempt".concat(y)],gazeDirection:x,gazeTiming:k,gazeVidType:T,videoDuration:e.duration,totalFramesProcessed:a},C({type:"UPDATE_SURVEY_DATA",attempt:y,task:h,data:t}),j("Processing complete! Data saved."),F(!1);return}let u=Math.min(l+.03333333333333333,e.duration);e.currentTime=u}catch(e){console.error("Frame processing error:",e),j("Error processing frame ".concat(a,": ").concat(e))}finally{a++}},c=async()=>{await n()};return e.addEventListener("timeupdate",c),F(!0),e.currentTime=0,()=>{e.removeEventListener("timeupdate",c)}};return(0,a.jsx)("div",{className:"w-full h-full bg-gray-800 flex items-center justify-center align-middle",children:(0,a.jsxs)("div",{className:"w-full bg-white container max-w-3xl rounded-md",children:[(0,a.jsx)("div",{className:"w-full flex items-start justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600",children:(0,a.jsx)("h3",{className:"text-xl capitalize text-center font-semibold text-gray-900",children:_?"Wait while we process the video.":"Hurray, You have completed the survey!"})}),(0,a.jsxs)("div",{className:"p-4",children:[_&&(0,a.jsx)("p",{id:"eye-direction",className:"text-center text-gray-400 text-base",children:N}),(0,a.jsxs)("div",{className:"w-full h-[300px] max-w-2xl m-auto flex flex-col items-center relative",children:[(0,a.jsx)("video",{className:"absolute h-full w-full max-w-xl rounded-lg bg-gray-800",id:"webcam",ref:v,playsInline:!0,muted:!0,children:"Your browser does not support the video tag."}),(0,a.jsx)("canvas",{className:"absolute h-full w-full rounded-lg",id:"output_canvas",ref:w}),_&&(0,a.jsx)("p",{children:"We are processing the video, please wait..."})]}),_&&(0,a.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2.5 mt-4",children:(0,a.jsx)("div",{className:"bg-blue-600 h-2.5 rounded-full",style:{width:"".concat(E,"%")}})})]}),(0,a.jsxs)("div",{className:"w-full flex items-center justify-center p-4 border-t border-gray-200 rounded-b dark:border-gray-600",children:[(0,a.jsx)("button",{disabled:_,onClick:()=>O.push("/survey"),className:"".concat(_?"cursor-not-allowed opacity-50":"cursor-pointer"," capitalize text-white bg-red-800 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:hover:bg-red-700 dark:focus:ring-red-800"),children:"Go to Dashboard"}),t&&(0,a.jsx)("button",{disabled:_,onClick:()=>{!_&&window.location&&(window.location.href=t)},className:"".concat(_?"cursor-not-allowed opacity-50":"cursor-pointer"," ms-3 text-gray-200 bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:outline-none focus:ring-red-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5"),children:"Create New Attempt"})]})]})})}},3896:function(e,t,r){r.d(t,{_:function(){return a}});let a="/start"},6501:function(e,t,r){r.d(t,{Y:function(){return n},g:function(){return a}});let a={LOGGED_IN_USER:"start_user",MFA_ACCESS_TOKEN:"x-secure-token",MFA_REFRESH_TOKEN:"x-refresh-token",SELECTED_COUNTRY:"psychSelectedCountry",SELECTED_COUNTRY_NAME:"psychSelectedCountryName",SELECTED_VENDORCODE:"psychSelectedVendorCode",SELECTED_LANGUAGE:"psychSelectedLanguageFilter",BASE_URL:"https://x3qrf2-3000.csb.app/api/v1",SURVEY_DATA:"surveyData"},n={surveyDB:"survey",surveyData:"surveyData",useData:"user",tempVideo:"tempVideo",temporaryDB:"temporary"}},1978:function(e,t){t.Z=["BubblePoppingTask","DelayedGratificationTask","MotorFollowingTask","ButtonTask","SynchronyTask","LanguageSamplingTask","WheelTask","PreferentialLookingTask"]},6105:function(e,t,r){r.d(t,{l:function(){return a},o:function(){return n}});let a=e=>new Promise((t,r)=>{let a=new FileReader;a.onloadend=()=>{a.result?t(a.result.split(",")[1]):r("Failed to convert file to base64")},a.onerror=()=>{r("File reading error")},a.readAsDataURL(e)});function n(e,t,r){let a=atob(e.split(",")[1]||e),n=a.length,o=new Uint8Array(n);for(let e=0;e<n;e++)o[e]=a.charCodeAt(e);let c=new Blob([o],{type:t});if(!r){let e=t.split("/")[1]||"file";r="file.".concat(e)}return new File([c],r,{type:t})}},2635:function(e,t,r){r.d(t,{SurveyProvider:function(){return f},y:function(){return m}});var a=r(7437),n=r(6501),o=r(7727),c=r(1978);let l=()=>{let{childID:e,childDOB:t,childGender:r,observerID:a}=(0,o.jy)(n.g.LOGGED_IN_USER,!0)||{},l=n=>({assessment_id:n,noOfAttempt:0,attempt1:{},attempt2:{},attempt3:{},userID:e,userDOB:t,userGender:r,observerID:a});return c.Z.reduce((e,t)=>(e[t]=l(t),e),{})};var i=r(2807),s=r(2265);let d=(0,s.createContext)(void 0),u=(e,t)=>{switch(t.type){case"SET_SURVEY_DATA":return{...e,...t.payload};case"UPDATE_SURVEY_DATA":var r;return{...e,[t.task]:{...e[t.task],noOfAttempt:t.attempt,["attempt".concat(t.attempt)]:{...null===(r=e[t.task])||void 0===r?void 0:r["attempt".concat(null==t?void 0:t.attempt)],...t.data}}};case"RESET_SURVEY_DATA":return l();default:return{...e}}},f=e=>{let{children:t}=e,[r,o]=(0,s.useReducer)(u,l()),[c,f]=(0,s.useState)(!1);return(0,s.useEffect)(()=>{(async()=>{try{let e=await (0,i.VS)(n.Y.surveyDB,n.Y.surveyData);e&&!c&&o({type:"SET_SURVEY_DATA",payload:e})}catch(e){console.error("Failed to load persisted survey state:",e)}finally{f(!0)}})()},[c]),(0,s.useEffect)(()=>{c&&(async()=>{try{await (0,i.TP)(n.Y.surveyDB,n.Y.surveyData,r)}catch(e){console.error("Failed to save survey state:",e)}})()},[r,c]),(0,a.jsx)(d.Provider,{value:{state:r,dispatch:o},children:t})},m=()=>{let e=(0,s.useContext)(d);if(!e)throw Error("useSurveyContext must be used within a SurveyProvider");return e}},2807:function(e,t,r){function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return new Promise((r,a)=>{let n=indexedDB.open(e,t);n.onsuccess=()=>r(n.result),n.onerror=()=>a("Failed to open database: ".concat(e)),n.onupgradeneeded=()=>{let e=n.result;e.objectStoreNames.contains("data")||e.createObjectStore("data")}})}async function n(e,t,r){try{let n=await a(e),o=n.transaction("data","readwrite");o.objectStore("data").put(r,t),o.oncomplete=()=>{n.close()},o.onerror=t=>{console.error("Transaction error in ".concat(e,":"),t)}}catch(t){console.error("Error setting value in ".concat(e,":"),t)}}async function o(e,t){try{let r=await a(e);return new Promise((a,n)=>{let o=r.transaction("data","readonly").objectStore("data").get(t);o.onsuccess=()=>{let e=o.result;a(e),r.close()},o.onerror=()=>{n("Failed to retrieve data from ".concat(e)),r.close()}})}catch(t){return console.error("Error getting value from ".concat(e,":"),t),null}}async function c(e,t){try{let r=await a(e),n=r.transaction("data","readwrite");n.objectStore("data").delete(t),n.oncomplete=()=>r.close()}catch(t){console.error("Error removing value from ".concat(e,":"),t)}}r.d(t,{TP:function(){return n},VS:function(){return o},pV:function(){return c}}),r(6501)},7727:function(e,t,r){function a(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("localStorage"in window)try{let r=window.localStorage.getItem(e);if(!r)return null;if(!t)return r;if(r)return JSON.parse(r)}catch(e){}return null}function n(e,t,r){if("localStorage"in window)try{r?window.localStorage.setItem(e,JSON.stringify(t)):"string"==typeof t&&window.localStorage.setItem(e,t)}catch(e){console.log(e)}return null}function o(){"localStorage"in window&&window.localStorage.clear()}r.d(t,{jy:function(){return a},pO:function(){return o},uN:function(){return n}})}}]);